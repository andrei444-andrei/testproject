<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Веб‑калькулятор</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --btn: #1f2937;
      --btn-hover: #374151;
      --accent: #22c55e;
      --danger: #ef4444;
      --text: #e5e7eb;
      --muted: #9ca3af;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: radial-gradient(1200px 800px at 50% -20%, #1f2937 0%, var(--bg) 55%);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    .calc {
      width: 360px;
      background: linear-gradient(180deg, #111827, #0b1020);
      border: 1px solid #1f2937;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.45), inset 0 1px 0 rgba(255,255,255,0.05);
      overflow: hidden;
    }
    .display {
      min-height: 96px;
      padding: 16px 16px 8px 16px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      background: linear-gradient(180deg, #0b1223, #0b0f1b);
      border-bottom: 1px solid #1f2937;
    }
    .expr {
      min-height: 22px;
      color: var(--muted);
      font-size: 14px;
      letter-spacing: 0.3px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    .result {
      font-size: 28px;
      font-weight: 600;
      text-align: right;
      letter-spacing: 0.5px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      padding: 12px;
    }
    button {
      appearance: none;
      border: none;
      border-radius: 10px;
      padding: 14px 0;
      background: var(--btn);
      color: var(--text);
      font-size: 18px;
      cursor: pointer;
      transition: background 0.15s ease, transform 0.02s ease;
      box-shadow: 0 1px 0 rgba(255,255,255,0.05) inset, 0 1px 2px rgba(0,0,0,0.35);
    }
    button:hover { background: var(--btn-hover); }
    button:active { transform: translateY(1px); }
    .span-2 { grid-column: span 2; }
    .op { color: #93c5fd; }
    .accent { background: linear-gradient(180deg, #22c55e, #16a34a); color: #0b0f1b; font-weight: 700; }
    .accent:hover { background: linear-gradient(180deg, #34d399, #16a34a); }
    .danger { color: #fecaca; }
    .muted { color: var(--muted); }
    .footer { text-align: center; font-size: 12px; color: var(--muted); padding: 8px 0 14px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="calc" role="application" aria-label="Калькулятор">
    <div class="display">
      <div id="expr" class="expr" aria-live="polite"></div>
      <div id="res" class="result" aria-live="polite">0</div>
    </div>
    <div class="grid" aria-label="Кнопки калькулятора">
      <button data-action="clear" class="danger">C</button>
      <button data-action="back" class="muted">⌫</button>
      <button data-insert="%" class="op">%</button>
      <button data-insert="/" class="op">÷</button>

      <button data-insert="7">7</button>
      <button data-insert="8">8</button>
      <button data-insert="9">9</button>
      <button data-insert="*" class="op">×</button>

      <button data-insert="4">4</button>
      <button data-insert="5">5</button>
      <button data-insert="6">6</button>
      <button data-insert="-" class="op">−</button>

      <button data-insert="1">1</button>
      <button data-insert="2">2</button>
      <button data-insert="3">3</button>
      <button data-insert="+" class="op">+</button>

      <button data-insert="(">(</button>
      <button data-insert=")">)</button>
      <button data-insert=".">.</button>
      <button data-insert="^" class="op">^</button>

      <button data-insert="0" class="span-2">0</button>
      <button data-action="equals" class="accent span-2">=</button>
    </div>
    <div class="footer">Поддержка: +, −, ×, ÷, %, ^, скобки, унарный −</div>
  </div>

  <script>
    const exprEl = document.getElementById('expr');
    const resEl = document.getElementById('res');

    let buffer = '';
    let lastResult = null;

    const isDigit = (c) => /[0-9]/.test(c);

    function addToBuffer(text) {
      // Если предыдущий результат показан и вводится цифра — начинаем новое выражение
      if (lastResult !== null && /^[0-9.(]$/.test(text)) {
        buffer = '' + lastResult;
        lastResult = null;
      }
      buffer += text;
      render();
    }

    function clearAll() {
      buffer = '';
      lastResult = null;
      render();
    }

    function backspace() {
      if (buffer.length > 0) buffer = buffer.slice(0, -1);
      render();
    }

    function render(resultText) {
      exprEl.textContent = buffer;
      resEl.textContent = resultText !== undefined ? resultText : (buffer ? '' : '0');
    }

    // Парсер выражений (Shunting-yard) с поддержкой унарных операторов
    function tokenize(input) {
      const tokens = [];
      let i = 0;
      while (i < input.length) {
        const ch = input[i];
        if (ch === ' ' || ch === '\t') { i++; continue; }

        if (isDigit(ch) || ch === '.') { // число
          let start = i;
          let hasDot = ch === '.';
          i++;
          while (i < input.length) {
            const c = input[i];
            if (isDigit(c)) { i++; continue; }
            if (c === '.' && !hasDot) { hasDot = true; i++; continue; }
            break;
          }
          const numStr = input.slice(start, i);
          if (numStr === '.' || numStr === '') throw new Error('Неверное число');
          tokens.push({ type: 'num', value: parseFloat(numStr) });
          continue;
        }

        if ('+-*/%^()'.includes(ch)) {
          // Обрабатываем унарные +/−: в начале или после оператора/скобки
          if ((ch === '+' || ch === '-') && (tokens.length === 0 || ['op', 'lparen'].includes(tokens[tokens.length - 1].type))) {
            tokens.push({ type: 'uop', op: ch === '+' ? 'u+' : 'u-' });
          } else if (ch === '(') {
            tokens.push({ type: 'lparen' });
          } else if (ch === ')') {
            tokens.push({ type: 'rparen' });
          } else {
            tokens.push({ type: 'op', op: ch });
          }
          i++;
          continue;
        }

        throw new Error('Недопустимый символ: ' + ch);
      }
      return tokens;
    }

    function toRPN(tokens) {
      const output = [];
      const stack = [];

      const prec = {
        'u+': 5, 'u-': 5, // унарные самые приоритетные
        '^': 4,
        '*': 3, '/': 3, '%': 3,
        '+': 2, '-': 2,
      };
      const rightAssoc = { '^': true }; // правая ассоциативность только у ^

      for (const t of tokens) {
        if (t.type === 'num') {
          output.push(t);
        } else if (t.type === 'uop') {
          stack.push(t); // унарные как операторы на стек
        } else if (t.type === 'op') {
          while (stack.length) {
            const top = stack[stack.length - 1];
            if ((top.type === 'op' || top.type === 'uop')) {
              const topOp = top.type === 'uop' ? top.op : top.op;
              if (
                (rightAssoc[t.op] ? prec[t.op] < prec[topOp] : prec[t.op] <= prec[topOp])
              ) {
                output.push(stack.pop());
                continue;
              }
            }
            break;
          }
          stack.push(t);
        } else if (t.type === 'lparen') {
          stack.push(t);
        } else if (t.type === 'rparen') {
          while (stack.length && stack[stack.length - 1].type !== 'lparen') {
            output.push(stack.pop());
          }
          if (!stack.length) throw new Error('Несогласованные скобки');
          stack.pop(); // снять '('
        }
      }

      while (stack.length) {
        const top = stack.pop();
        if (top.type === 'lparen' || top.type === 'rparen') throw new Error('Несогласованные скобки');
        output.push(top);
      }
      return output;
    }

    function evalRPN(rpn) {
      const st = [];
      for (const t of rpn) {
        if (t.type === 'num') {
          st.push(t.value);
        } else if (t.type === 'uop') {
          if (st.length < 1) throw new Error('Ошибка выражения');
          const a = st.pop();
          st.push(t.op === 'u-' ? -a : +a);
        } else if (t.type === 'op') {
          if (st.length < 2) throw new Error('Ошибка выражения');
          const b = st.pop();
          const a = st.pop();
          let r;
          switch (t.op) {
            case '+': r = a + b; break;
            case '-': r = a - b; break;
            case '*': r = a * b; break;
            case '/':
              if (b === 0) throw new Error('Деление на ноль недопустимо');
              r = a / b; break;
            case '%':
              if (b === 0) throw new Error('Деление на ноль недопустимо');
              r = a % b; break;
            case '^': r = Math.pow(a, b); break;
            default: throw new Error('Неизвестный оператор');
          }
          st.push(r);
        }
      }
      if (st.length !== 1) throw new Error('Ошибка выражения');
      return st[0];
    }

    function safeEvaluate(expr) {
      const tokens = tokenize(expr);
      const rpn = toRPN(tokens);
      const value = evalRPN(rpn);
      if (!Number.isFinite(value)) throw new Error('Неверный результат');
      return value;
    }

    function onEquals() {
      if (!buffer.trim()) return;
      try {
        const value = safeEvaluate(buffer.replace(/×/g, '*').replace(/÷/g, '/'));
        lastResult = value;
        render(String(value));
      } catch (e) {
        render('Ошибка: ' + (e && e.message ? e.message : 'не удалось вычислить'));
      }
    }

    document.querySelector('.grid').addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const toInsert = btn.getAttribute('data-insert');
      const action = btn.getAttribute('data-action');
      if (toInsert) {
        addToBuffer(toInsert);
      } else if (action === 'clear') {
        clearAll();
      } else if (action === 'back') {
        backspace();
      } else if (action === 'equals') {
        onEquals();
      }
    });

    // Поддержка клавиатуры
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === '=') { e.preventDefault(); onEquals(); return; }
      if (e.key === 'Backspace') { e.preventDefault(); backspace(); return; }
      if (e.key.toLowerCase() === 'c' && (e.ctrlKey || e.metaKey)) { return; }
      if (e.key === 'Escape') { e.preventDefault(); clearAll(); return; }

      const allowed = '0123456789+-*/%^().';
      if (allowed.includes(e.key)) {
        e.preventDefault();
        addToBuffer(e.key);
      }
    });

    render();
  </script>
</body>
</html> 